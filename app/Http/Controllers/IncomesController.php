<?php

namespace App\Http\Controllers;

use App\Models\Document;
use App\Models\DocumentItem;
use App\Models\DocumentType;
use App\Models\Expense;
use App\Models\Unit_measurement;
use App\Models\WarehouseItem;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Http\JsonResponse;

class IncomesController extends Controller
{
    public function storeIncomes(Request $request): JsonResponse
{
    Log::info($request);
    /* 1.  VALIDATE  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
    $data = $request->validate([
        'providerId'            => ['nullable','uuid','exists:providers,id'],
        'assigned_warehouse_id' => ['required','uuid','exists:warehouses,id'],
        'docDate'               => ['nullable','date'],

        'products'                                => ['required','array','min:1'],
        'products.*.product.id'                   => ['required','uuid','exists:product_sub_cards,id'],
        'products.*.unit.id'                      => ['required','uuid','exists:unit_measurements,id'],
        'products.*.qtyTare'                      => ['nullable','numeric'],
        'products.*.brutto'                       => ['nullable','numeric'],
        'products.*.netto'                        => ['nullable','numeric'],
        'products.*.price'                        => ['required','numeric'],
        'products.*.total_sum'                    => ['required','numeric'],
        'products.*.additional_expenses'          => ['nullable','numeric'],
        'products.*.cost_price'                   => ['nullable','numeric'],

        'expenses'                                => ['sometimes','array'],
        'expenses.*.name.id'                      => ['required_with:expenses','uuid'],
        'expenses.*.name.name'                    => ['required_with:expenses','string'],
        'expenses.*.provider.id'                  => ['nullable','uuid','exists:providers,id'],
        'expenses.*.amount'                       => ['required_with:expenses','numeric'],
    ]);

    /* 2.  –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º ¬´—Å–≤–æ–∏¬ª –¥–∞–Ω–Ω—ã–µ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
    $orgId      = $request->user()->organization_id;              // üëà
    $whId       = $data['assigned_warehouse_id'];                 // uuid
    $providerId = $data['providerId']  ?? null;
    $docDate    = Carbon::parse($data['docDate'] ?? now())->toDateString();

    $products = collect($data['products']);
    $expenses = collect($data['expenses'] ?? []);

    /* 3.  –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
    DB::beginTransaction();
    try {
        /** 3-A. Header */
        $incomeType = DocumentType::where('code', 'income')->firstOrFail();

        $doc = Document::create([
            'organization_id'   => $orgId,                    // üëà
            'document_type_id'  => $incomeType->id,
            'status'            => '+',
            'provider_id'       => $providerId,
            'to_warehouse_id'   => $whId,
            'document_date'     => $docDate,
            'comments'          => $request->input('comments',''),
        ]);

        /** 3-B. –°—Ç—Ä–æ–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ + –æ—Å—Ç–∞—Ç–∫–∏ —Å–∫–ª–∞–¥–∞ */
        foreach ($products as $row) {

            $prodId   = data_get($row,'product.id');
            $unitId   = data_get($row,'unit.id');
            $unit     = Unit_measurement::findOrFail($unitId);   // –Ω—É–∂–µ–Ω name
            $unitName = $unit->name;

            $qty = $row['qtyTare'] !== null
                     ? (float)$row['qtyTare']
                     : (float)($row['netto'] ?? 0);

            /* —Å—Ç—Ä–æ–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
            DocumentItem::create([
                'document_id'        => $doc->id,
                'product_subcard_id' => $prodId,
                'unit_measurement'   => $unitName,
                'quantity'           => $qty,
                'brutto'             => (float)($row['brutto'] ?? 0),
                'netto'              => (float)($row['netto']  ?? 0),
                'price'              => (float)$row['price'],
                'total_sum'          => (float)$row['total_sum'],
                'additional_expenses'=> (float)($row['additional_expenses'] ?? 0),
                'cost_price'         => (float)($row['cost_price']          ?? 0),
                'net_unit_weight'    => $qty>0 ? round(($row['netto']??0)/$qty,4) : 0,
            ]);

            /* —Å–∫–ª–∞–¥—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è */
            $whItem = WarehouseItem::firstOrNew([
                'warehouse_id'       => $whId,
                'product_subcard_id' => $prodId,
                'unit_measurement'   => $unitName,
                'document_id' => $doc->id,
            ]);

            $whItem->quantity            += $qty;
            $whItem->brutto              += (float)($row['brutto'] ?? 0);
            $whItem->netto               += (float)($row['netto']  ?? 0);
            $whItem->total_sum           += (float)$row['total_sum'];
            $whItem->additional_expenses += (float)($row['additional_expenses'] ?? 0);
            $whItem->price                = (float)$row['price'];
            $whItem->cost_price           = (float)($row['cost_price'] ?? 0);
            $whItem->save();
        }

        /** 3-C. –î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã */
        foreach ($expenses as $e) {
            Expense::create([
                'organization_id' => $orgId,                       // üëà
                'document_id'     => $doc->id,
                'name'            => data_get($e,'name.name'),
                'provider_id'     => data_get($e,'provider.id'),
                'amount'          => (float)$e['amount'],
            ]);
        }

        DB::commit();

        return response()->json([
            'success' => true,
            'message' => "Document {$doc->id} saved",
        ], 201);

    } catch (\Throwable $e) {
        DB::rollBack();
        Log::error('IncomeStore: '.$e->getMessage());
        return response()->json(['success'=>false,'error'=>$e->getMessage()], 500);
    }
}


public function updateIncomes(Request $request, Document $document): JsonResponse
{
    Log::info($request->all());
    /* 0. –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ ¬´–ü—Ä–∏—Ö–æ–¥¬ª */
    $document->load('documentType', 'items', 'expenses');
    if ($document->documentType->code !== 'income') {
        return response()->json(['success'=>false,'error'=>'Not an income document'], 400);
    }

    /* 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–≤ —Ç–æ–π –∂–µ —Ñ–æ—Ä–º–µ, —á—Ç–æ –∏ create) */
    $v = $request->validate([
        'providerId'             => ['nullable','uuid','exists:providers,id'],
        'assigned_warehouse_id'  => ['required','uuid','exists:warehouses,id'],
        'docDate'                => ['nullable','date'],

        'products'                               => ['required','array','min:1'],

        'products.*.product.id'                  => ['required','uuid','exists:product_sub_cards,id'],
        'products.*.unit.name'                   => ['required','string'],

        'products.*.qtyTare'            => ['nullable','numeric'],
        'products.*.quantity'           => ['nullable','numeric'],
        'products.*.price'              => ['nullable','numeric'],
        'products.*.brutto'             => ['nullable','numeric'],
        'products.*.netto'              => ['nullable','numeric'],
        'products.*.total_sum'          => ['nullable','numeric'],
        'products.*.additional_expenses'=> ['nullable','numeric'],
        'products.*.cost_price'         => ['nullable','numeric'],

        'expenses'                      => ['nullable','array'],
        'expenses.*.name.id'            => ['nullable','uuid'],
        'expenses.*.amount'             => ['nullable','numeric'],
        'expenses.*.provider.id'        => ['nullable','uuid','exists:providers,id'],
    ]);

    /* –∫—Ä–∞—Ç–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
    $whId   = $v['assigned_warehouse_id'];
    $pId    = $v['providerId'] ?? null;
    $date   = Carbon::parse($v['docDate'] ?? now())->toDateString();
    $rows   = collect($v['products']);
    $costs  = collect($v['expenses'] ?? []);

    DB::beginTransaction();
    try {
        /* 2-A. –û—Ç–∫–∞—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–∏—Ö–æ–¥—ã —Å–æ —Å–∫–ª–∞–¥–∞ */
        foreach ($document->items as $old) {
            $stock = WarehouseItem::where([
                        'warehouse_id'       => $document->to_warehouse_id,
                        'product_subcard_id' => $old->product_subcard_id,
                        'unit_measurement'   => $old->unit_measurement,
                    ])->first();

            if ($stock) {               // –±—ã–≤–∞—é—Ç —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å —É–∂–µ —É–¥–∞–ª–∏–ª–∏
                $stock->quantity    -= $old->quantity;
                $stock->brutto      -= $old->brutto;
                $stock->netto       -= $old->netto;
                $stock->total_sum   -= $old->total_sum;
                $stock->save();
            }
        }

        /* 2-B. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Ä–∞—Å—Ö–æ–¥—ã */
        $document->items()->delete();
        $document->expenses()->delete();

        /* 2-C. –û–±–Ω–æ–≤–ª—è–µ–º ¬´—à–∞–ø–∫—É¬ª */
        $document->update([
            'provider_id'     => $pId,
            'to_warehouse_id' => $whId,
            'document_date'   => $date,
            'comments'        => $request->input('comments',''),
        ]);

        /* 2-D. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–ª–∞–¥ */
        foreach ($rows as $r) {
            $prodId   = data_get($r,'product.id');
            $unitName = data_get($r,'unit.name');
            $qty      = (float)($r['qtyTare'] ?? $r['quantity'] ?? 0);
            $brutto   = (float)($r['brutto'] ?? 0);
            $netto    = (float)($r['netto']  ?? 0);
            $sum      = (float)($r['total_sum'] ?? 0);

            /* ‚Äì –∑–∞–ø–∏—Å—å –Ω–∞ —Å–∫–ª–∞–¥–µ */
            $stock = WarehouseItem::firstOrNew([
                        'warehouse_id'       => $whId,
                        'product_subcard_id' => $prodId,
                        'unit_measurement'   => $unitName,
                    ]);

            $stock->quantity  += $qty;
            $stock->brutto    += $brutto;
            $stock->netto     += $netto;
            $stock->total_sum += $sum;
            $stock->price      = $r['price']       ?? $stock->price ?? 0;
            $stock->cost_price = $r['cost_price']  ?? $stock->cost_price ?? 0;
            $stock->save();

            /* ‚Äì —Å—Ç—Ä–æ–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
            DocumentItem::create([
                'document_id'        => $document->id,
                'product_subcard_id' => $prodId,
                'unit_measurement'   => $unitName,
                'quantity'           => $qty,
                'brutto'             => $brutto,
                'netto'              => $netto,
                'price'              => $r['price']      ?? 0,
                'total_sum'          => $sum,
                'additional_expenses'=> $r['additional_expenses'] ?? 0,
                'cost_price'         => $r['cost_price'] ?? 0,
                'net_unit_weight'    => $qty>0 ? round($netto/$qty,4) : 0,
            ]);
        }

        /* 2-E. –†–∞—Å—Ö–æ–¥—ã */
        foreach ($costs as $c) {
            Expense::create([
                'document_id' => $document->id,
                'name'        => data_get($c,'name.name','–†–∞—Å—Ö–æ–¥'),
                'amount'      => $c['amount'] ?? 0,
                'provider_id' => data_get($c,'provider.id'),
            ]);
        }

        DB::commit();
        return response()->json([
            'success'=>true,
            'message'=>'Income document updated',
            'doc_id' =>$document->id,
        ]);

    } catch (\Throwable $e) {
        DB::rollBack();
        Log::error('updateIncomes', ['msg'=>$e->getMessage()]);
        return response()->json(['success'=>false,'error'=>$e->getMessage()],500);
    }
}

/**
 * DELETE /income-products/{document}
 */
public function destroyIncomes(Document $document): JsonResponse
{
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ ¬´–ü—Ä–∏—Ö–æ–¥¬ª */
    $document->load('documentType','items','expenses');
    if ($document->documentType->code !== 'income') {
        return response()->json(['success'=>false,'error'=>'Not an income document'], 400);
    }

    DB::beginTransaction();
    try {
        $whId = $document->to_warehouse_id;

        /* 1. –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞ */
        foreach ($document->items as $row) {
            $stock = WarehouseItem::where([
                        'warehouse_id'       => $whId,
                        'product_subcard_id' => $row->product_subcard_id,
                        'unit_measurement'   => $row->unit_measurement,
                    ])->first();

            if ($stock) {
                $stock->quantity  -= $row->quantity;
                $stock->brutto    -= $row->brutto;
                $stock->netto     -= $row->netto;
                $stock->total_sum -= $row->total_sum;
                $stock->save();
            }
        }

        /* 2. –ß–∏—Å—Ç–∏–º —Å—Ç—Ä–æ–∫–∏ –∏ —Ä–∞—Å—Ö–æ–¥—ã, —É–¥–∞–ª—è–µ–º —Å–∞–º –¥–æ–∫—É–º–µ–Ω—Ç */
        $document->items()->delete();
        $document->expenses()->delete();
        $document->delete();

        DB::commit();
        return response()->json(['success'=>true,'message'=>'Income document deleted']);

    } catch (\Throwable $e) {
        DB::rollBack();
        Log::error('destroyIncomes', ['msg'=>$e->getMessage()]);
        return response()->json(['success'=>false,'error'=>$e->getMessage()],500);
    }
}

}
